# MongoDBSplitTree
MongDB读写分离，分片技术研究


![](https://i.imgur.com/85MTPOG.png)

![](https://i.imgur.com/EKBoE7k.png)

在三台机器上部署：
    mongos 3个， config server 3个，数据分3片 shard server 3个，每个shard 有一个副
    本一个仲裁也就是 3 * 2 = 6 个，总共需要部署15个实例

![](https://i.imgur.com/2WR8Xw1.png)

<pre>
四个组件：
    mongos、config server、shard、replica set

	mongos，数据库集群请求的入口，所有的请求都通过mongos进行协调，不需要在应用程序添加一
    个路由选择器，mongos自己就是一个请求分发中心，它负责把对应的数据请求请求转发到对应
    的shard服务器上。在生产环境通常有多mongos作为请求的入口，防止其中一个挂掉所有的
    mongodb请求都没有办法操作。

    config server，顾名思义为配置服务器，存储所有数据库元信息（路由、分片）的配置。
    mongos本身没有物理存储分片服务器和数据路由信息，只是缓存在内存里，配置服务器则实际
    存储这些数据。mongos第一次启动或者关掉重启就会从 config server 加载配置信息，以后如
    果配置服务器信息变化会通知到所有的 mongos 更新自己的状态，这样 mongos 就能继续准确
    路由。在生产环境通常有多个 config server 配置服务器，因为它存储了分片路由的元数据，
    这个可不能丢失！就算挂掉其中一台，只要还有存货， mongodb集群就不会挂掉。

    shard，这就是传说中的分片了。上面提到一个机器就算能力再大也有天花板，就像军队打仗一
    样，一个人再厉害喝血瓶也拼不过对方的一个师。俗话说三个臭皮匠顶个诸葛亮，这个时候团队的
    力量就凸显出来了。在互联网也是这样，一台普通的机器做不了的多台机器来做

    一台机器的一个数据表 Collection1 存储了 1T 数据，压力太大了！在分给4个机器后，每
    个机器都是256G，则分摊了集中在一台机器的压力。也许有人问一台机器硬盘加大一点不就可以
    了，为什么要分给四台机器呢？不要光想到存储空间，实际运行的数据库还有硬盘的读写、网络
    的IO、CPU和内存的瓶颈。在mongodb集群只要设置好了分片规则，通过mongos操作数据库就能自
    动把对应的数据操作请求转发到对应的分片机器上。在生产环境中分片的片键可要好好设置，这
    个影响到了怎么把数据均匀分到多个分片机器上，不要出现其中一台机器分了1T，其他机器没有
    分到的情况，这样还不如不分片

    replica set，上两节已经详细讲过了这个东东，怎么这里又来凑热闹！其实上图4个分片如果没
    有 replica set 是个不完整架构，假设其中的一个分片挂掉那四分之一的数据就丢失了，所以
    在高可用性的分片架构还需要对于每一个分片构建 replica set 副本集保证分片的可靠性。生
    产环境通常是 2个副本 + 1个仲裁
</pre>